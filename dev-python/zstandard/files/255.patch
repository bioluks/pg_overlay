From b4a58694415e453a38617205affd590699f9b726 Mon Sep 17 00:00:00 2001
From: "Bernhard M. Wiedemann" <bwiedemann@suse.de>
Date: Fri, 21 Feb 2025 20:59:18 +0100
Subject: [PATCH] Use zstd-1.5.7

this changed compression results, so we have to adapt tests
---
 c-ext/backend_c.c                      | 2 +-
 tests/test_compressor_compress.py      | 2 +-
 tests/test_compressor_compressobj.py   | 2 +-
 tests/test_compressor_copy_stream.py   | 2 +-
 tests/test_compressor_stream_writer.py | 2 +-
 tests/test_module_attributes.py        | 2 +-
 6 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/c-ext/backend_c.c b/c-ext/backend_c.c
index aabe30bc..4b09d1fb 100644
--- a/c-ext/backend_c.c
+++ b/c-ext/backend_c.c
@@ -152,7 +152,7 @@ void zstd_module_init(PyObject *m) {
     PyObject *features = NULL;
     PyObject *feature = NULL;
     unsigned zstd_ver_no = ZSTD_versionNumber();
-    unsigned our_hardcoded_version = 10506;
+    unsigned our_hardcoded_version = 10507;
     if (ZSTD_VERSION_NUMBER != our_hardcoded_version ||
         zstd_ver_no != our_hardcoded_version) {
         PyErr_Format(
diff --git a/tests/test_compressor_compress.py b/tests/test_compressor_compress.py
index c0aef576..50bfc952 100644
--- a/tests/test_compressor_compress.py
+++ b/tests/test_compressor_compress.py
@@ -52,7 +52,7 @@ def test_compress_large(self):
 
         cctx = zstd.ZstdCompressor(level=3, write_content_size=False)
         result = cctx.compress(b"".join(chunks))
-        self.assertEqual(len(result), 999)
+        self.assertEqual(len(result), 1029)
         self.assertEqual(result[0:4], b"\x28\xb5\x2f\xfd")
 
         # This matches the test for read_to_iter() below.
diff --git a/tests/test_compressor_compressobj.py b/tests/test_compressor_compressobj.py
index f429b320..b89ae201 100644
--- a/tests/test_compressor_compressobj.py
+++ b/tests/test_compressor_compressobj.py
@@ -39,7 +39,7 @@ def test_compressobj_large(self):
         cobj = cctx.compressobj()
 
         result = cobj.compress(b"".join(chunks)) + cobj.flush()
-        self.assertEqual(len(result), 999)
+        self.assertEqual(len(result), 1029)
         self.assertEqual(result[0:4], b"\x28\xb5\x2f\xfd")
 
         params = zstd.get_frame_parameters(result)
diff --git a/tests/test_compressor_copy_stream.py b/tests/test_compressor_copy_stream.py
index 82c7ce71..685660f2 100644
--- a/tests/test_compressor_copy_stream.py
+++ b/tests/test_compressor_copy_stream.py
@@ -50,7 +50,7 @@ def test_large_data(self):
         r, w = cctx.copy_stream(source, dest)
 
         self.assertEqual(r, 255 * 16384)
-        self.assertEqual(w, 999)
+        self.assertEqual(w, 1029)
 
         params = zstd.get_frame_parameters(dest.getvalue())
         self.assertEqual(params.content_size, zstd.CONTENTSIZE_UNKNOWN)
diff --git a/tests/test_compressor_stream_writer.py b/tests/test_compressor_stream_writer.py
index 08f52840..1f1855fc 100644
--- a/tests/test_compressor_stream_writer.py
+++ b/tests/test_compressor_stream_writer.py
@@ -301,7 +301,7 @@ def test_dictionary(self):
         d = zstd.train_dictionary(8192, samples)
 
         h = hashlib.sha1(d.as_bytes()).hexdigest()
-        self.assertEqual(h, "a46d2f7a3bc3357c9d717d3dadf9a26fde23e93d")
+        self.assertEqual(h, "f32ddfbe0878bbd428afc00b17810387c6752191")
 
         buffer = io.BytesIO()
         cctx = zstd.ZstdCompressor(level=9, dict_data=d)
diff --git a/tests/test_module_attributes.py b/tests/test_module_attributes.py
index ac95f573..9503a706 100644
--- a/tests/test_module_attributes.py
+++ b/tests/test_module_attributes.py
@@ -5,7 +5,7 @@
 
 class TestModuleAttributes(unittest.TestCase):
     def test_version(self):
-        self.assertEqual(zstd.ZSTD_VERSION, (1, 5, 6))
+        self.assertEqual(zstd.ZSTD_VERSION, (1, 5, 7))
 
         self.assertEqual(zstd.__version__, "0.24.0.dev0")
 
